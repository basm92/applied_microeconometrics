---
title: "Applied Microeconometrics - Assignment 4"
author: "Walter Verwer (589962) & Bas Machielsen (590049)"
date: \today
output:
  pdf_document:
    includes:
      in_header: preamble.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse); library(stargazer); library(modelsummary)
library(kableExtra); library(sandwich); library(survival)

dataset <- haven::read_dta("./FlowSpells.dta") 
```

1. Describe the sickness spell data, i.e. do a simple listing of the survivor function and plot the hazard rate and the survivor function. Make separate plots for the first two weeks and for the first year. Also plot the hazard by different subgroups (for instance gender) and test whether the survival curves are the same for the different subgroups.

```{r}
# Construct dataset for the survival and hazard rates
create_hazard_rate <- function(df, ...) {
    
    dataset %>%
        filter(sptype==2) %>%
        group_by(splength, ...) %>%
        summarise(frequency=n()) %>%
        group_by(...) %>%
        mutate(total = sum(frequency), sum = cumsum(frequency)) %>%
        mutate(riskset= lag(total - sum)) %>%
        mutate(riskset = if_else(is.na(riskset),total, riskset)) %>%
        mutate(exit_rate = frequency/riskset, survivor_function = lead(riskset/total))
    
}

```

## Exit Rates 

```{r}
create_hazard_rate(dataset, gender) %>%
    filter(splength <= 365) %>%
    ggplot(aes(x = splength, 
               y = exit_rate, 
               group = as.factor(gender), 
               color = as.factor(gender))) + 
    geom_line() +
    ggtitle("Exit Rate First 365 Days")

create_hazard_rate(dataset, gender) %>%
    filter(splength <= 14) %>%
    ggplot(aes(x = splength, 
               y = exit_rate, 
               group = as.factor(gender), 
               color = as.factor(gender))) + 
    geom_line() +
    ggtitle("Exit Rate First 14 Days")


create_hazard_rate(dataset, contract) %>%
    filter(splength <= 365) %>%
    ggplot(aes(x = splength, 
               y = exit_rate, 
               group = as.factor(contract), 
               color = as.factor(contract))) + 
    geom_line() +
    ggtitle("Exit Rate First 365 Days")

create_hazard_rate(dataset, contract) %>%
    filter(splength <= 14) %>%
    ggplot(aes(x = splength, 
               y = exit_rate, 
               group = as.factor(contract), 
               color = as.factor(contract))) + 
    geom_line() +
    ggtitle("Exit Rate First 14 Days")

```

## Survivor function

```{r}
create_hazard_rate(dataset, gender) %>%
    filter(splength <= 365) %>%
    ggplot(aes(x = splength, 
               y = survivor_function, 
               group = as.factor(gender), 
               color = as.factor(gender))) + 
    geom_line() +
    ggtitle("Survivor Function First 365 Days")

create_hazard_rate(dataset, gender) %>%
    filter(splength <= 14) %>%
    ggplot(aes(x = splength, 
               y = survivor_function, 
               group = as.factor(gender), 
               color = as.factor(gender))) + 
    geom_line() +
    ggtitle("Survivor Function First 14 Days")


create_hazard_rate(dataset, contract) %>%
    filter(splength <= 365) %>%
    ggplot(aes(x = splength, 
               y = survivor_function, 
               group = as.factor(contract), 
               color = as.factor(contract))) + 
    geom_line() +
    ggtitle("Survivor Function First 365 Days")

create_hazard_rate(dataset, contract) %>%
    filter(splength <= 14) %>%
    ggplot(aes(x = splength, 
               y = survivor_function, 
               group = as.factor(contract), 
               color = as.factor(contract))) + 
    geom_line() +
    ggtitle("Survivor Function First 14 Days")

```


2. Estimate a Weibull and an Exponential model for sickness spells. Start with a very simple specification and you only include one regressor and subsequently add more regressors. Comment on the change in the Weibull parameters and the regression parameters when you add more variables to the model. Compare the estimates of both models.

Estimate separate Weibull models for males and females. Comment on the results (is it better to estimate separate models for males and females?) Estimate the Weibull duration model for other subgroups that may differ in their behavior and where the baseline hazard may differ.

```{r}
# Cluster standard errors on school

survival::survreg(data = dataset %>%
                      filter(sptype == 2),
                  formula = Surv(splength) ~ contract, dist = "weibull", 
                  cluster = schoolid) 


```

