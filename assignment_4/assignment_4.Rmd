---
title: "Applied Microeconometrics - Assignment 4"
author: "Walter Verwer (589962) & Bas Machielsen (590049)"
date: \today
output:
  pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(out.width = '200px',
                      out.height = '150px',
                      echo = FALSE, # Turn into true if you want to see the code
                      warning = FALSE,
                      message = FALSE)

library(tidyverse); library(stargazer); library(modelsummary)
library(kableExtra); library(sandwich); library(survival)

dataset <- haven::read_dta("./FlowSpells.dta") 
```

1. Describe the sickness spell data, i.e. do a simple listing of the survivor function and plot the hazard rate and the survivor function. Make separate plots for the first two weeks and for the first year. Also plot the hazard by different subgroups (for instance gender) and test whether the survival curves are the same for the different subgroups.

```{r}
# Construct dataset for the survival and hazard rates
create_hazard_rate <- function(df, ...) {
    
    dataset %>%
        filter(sptype==2) %>%
        group_by(splength, ...) %>%
        summarise(frequency=n()) %>%
        group_by(...) %>%
        mutate(total = sum(frequency), sum = cumsum(frequency)) %>%
        mutate(riskset= lag(total - sum)) %>%
        mutate(riskset = if_else(is.na(riskset),total, riskset)) %>%
        mutate(exit_rate = frequency/riskset, survivor_function = lead(riskset/total))
    
}

```

First, we plot the exit rates:

```{r}
create_hazard_rate(dataset, gender) %>%
    filter(splength <= 365) %>%
    ggplot(aes(x = splength, 
               y = exit_rate, 
               group = as.factor(gender), 
               color = as.factor(gender))) + 
    geom_line() +
    ggtitle("Exit Rate First 365 Days")

create_hazard_rate(dataset, gender) %>%
    filter(splength <= 14) %>%
    ggplot(aes(x = splength, 
               y = exit_rate, 
               group = as.factor(gender), 
               color = as.factor(gender))) + 
    geom_line() +
    ggtitle("Exit Rate First 14 Days")
```

```{r}
create_hazard_rate(dataset, contract) %>%
    filter(splength <= 365) %>%
    ggplot(aes(x = splength, 
               y = exit_rate, 
               group = as.factor(contract), 
               color = as.factor(contract))) + 
    geom_line() +
    ggtitle("Exit Rate First 365 Days")

create_hazard_rate(dataset, contract) %>%
    filter(splength <= 14) %>%
    ggplot(aes(x = splength, 
               y = exit_rate, 
               group = as.factor(contract), 
               color = as.factor(contract))) + 
    geom_line() +
    ggtitle("Exit Rate First 14 Days")

```

Then, we plot the survivor functions: 

```{r}
create_hazard_rate(dataset, gender) %>%
    filter(splength <= 365) %>%
    ggplot(aes(x = splength, 
               y = survivor_function, 
               group = as.factor(gender), 
               color = as.factor(gender))) + 
    geom_line() +
    ggtitle("Survivor Function First 365 Days")

create_hazard_rate(dataset, gender) %>%
    filter(splength <= 14) %>%
    ggplot(aes(x = splength, 
               y = survivor_function, 
               group = as.factor(gender), 
               color = as.factor(gender))) + 
    geom_line() +
    ggtitle("Survivor Function First 14 Days")
```

```{r}
create_hazard_rate(dataset, contract) %>%
    filter(splength <= 365) %>%
    ggplot(aes(x = splength, 
               y = survivor_function, 
               group = as.factor(contract), 
               color = as.factor(contract))) + 
    geom_line() +
    ggtitle("Survivor Function First 365 Days")

create_hazard_rate(dataset, contract) %>%
    filter(splength <= 14) %>%
    ggplot(aes(x = splength, 
               y = survivor_function, 
               group = as.factor(contract), 
               color = as.factor(contract))) + 
    geom_line() +
    ggtitle("Survivor Function First 14 Days")

```


2.1 Estimate a Weibull and an Exponential model for sickness spells. Start with a very simple specification and you only include one regressor and subsequently add more regressors. Comment on the change in the Weibull parameters and the regression parameters when you add more variables to the model. Compare the estimates of both models.

<!-- Hallo Walter, zie hier: https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html waarom ik dit zo correct doe! --> 


```{r}
# Cluster standard errors on school
model1 <- survival::survreg(data = dataset %>%
                      filter(sptype == 2) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1 + gender, dist = "weibull", 
                  cluster = schoolid) 

model2 <- update(model1, . ~ . + marstat)
model3 <- update(model2, . ~ . + contract)
model4 <- update(model3, . ~ . + lowgroup)
model5 <- update(model4, . ~ . + classize + schsize + public + protest)
model6 <- update(model5, . ~ . +  merged + avgfem + avgage + avglowgr)

models <- list(model1, model2, model3, model4, model5, model6)
```

```{r, results='asis'}
modelsummary(models,
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_omit = c("BIC|iter"),
             title = "Weibull Models",
             out = "kableExtra") %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "scale_down"))
```

\clearpage

```{r}
model1 <- survival::survreg(data = dataset %>%
                      filter(sptype == 2) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1 + gender, dist = "exponential", 
                  cluster = schoolid) 

model2 <- update(model1, . ~ . + marstat)
model3 <- update(model2, . ~ . + contract)
model4 <- update(model3, . ~ . + lowgroup)
model5 <- update(model4, . ~ . + classize + schsize + public + protest)
model6 <- update(model5, . ~ . +  merged + avgfem + avgage + avglowgr)

models2 <- list(model1, model2, model3, model4, model5, model6)

```

```{r, results='asis'}
modelsummary(models2,
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_omit = c("BIC|iter"),
             title = "Exponential Models",
             out = "kableExtra") %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "scale_down"))
```

\clearpage 

2.2 Estimate separate Weibull models for males and females. Comment on the results (is it better to estimate separate models for males and females?) Estimate the Weibull duration model for other subgroups that may differ in their behavior and where the baseline hazard may differ.

First, we estimate a model for males: 

```{r, results='asis'}
model1 <- survival::survreg(data = dataset %>%
                      filter(sptype == 2, gender == 1) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1, dist = "weibull", 
                  cluster = schoolid) 

model2 <- update(model1, . ~ . + marstat)
model3 <- update(model2, . ~ . + contract)
model4 <- update(model3, . ~ . + lowgroup)
model5 <- update(model4, . ~ . + classize + schsize + public + protest)
model6 <- update(model5, . ~ . +  merged + avgfem + avgage + avglowgr)

models <- list(model1, model2, model3, model4, model5, model6)
```


```{r, results='asis'}
modelsummary(models,
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_omit = c("BIC|iter"),
             title = "Weibull Models - Males Only",
             out = "kableExtra") %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "scale_down"))
```

<!-- Loglik are different, survDiff kunnen we gebruiken. --> 

\clearpage

Next, we estimate a model for females:

```{r, results='asis'}
model1 <- survival::survreg(data = dataset %>%
                      filter(sptype == 2, gender == 2) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1, dist = "weibull", 
                  cluster = schoolid) 

model2 <- update(model1, . ~ . + marstat)
model3 <- update(model2, . ~ . + contract)
model4 <- update(model3, . ~ . + lowgroup)
model5 <- update(model4, . ~ . + classize + schsize + public + protest)
model6 <- update(model5, . ~ . +  merged + avgfem + avgage + avglowgr)

models <- list(model1, model2, model3, model4, model5, model6)
```

```{r}
modelsummary(models,
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_omit = c("BIC|iter"),
             title = "Weibull Models - Females Only",
             out = "kableExtra") %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "scale_down"))
```



\clearpage

Now, given that under question 1 we observed a difference between the exit rates and the survival functions for the different contract types, we have estimated Weibull models for the contract types. However, our results are difficult to compare. The reason for this is that the models for the temporary and mixed contract have very little observations. Especially, the mixed contract has too little (36 observations). For this reason we can not make an educated comparison for this subgroup. 

```{r, results='asis'}
# Fixed contract
model1 <- survival::survreg(data = dataset %>%
                      filter(sptype == 2, contract == 1) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1, dist = "weibull", 
                  cluster = schoolid) 

model2 <- update(model1, . ~ . + marstat)
model3 <- update(model2, . ~ . + gender)
model4 <- update(model3, . ~ . + lowgroup)
model5 <- update(model4, . ~ . + classize + schsize + public + protest)
model_fixed <- update(model5, . ~ . +  merged + avgfem + avgage + avglowgr)

# Temporary contract
model1 <- survival::survreg(data = dataset %>%
                      filter(sptype == 2, contract == 2) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1, dist = "weibull", 
                  cluster = schoolid) 

model2 <- update(model1, . ~ . + marstat)
model3 <- update(model2, . ~ . + gender)
model4 <- update(model3, . ~ . + lowgroup)
model5 <- update(model4, . ~ . + classize + schsize + public + protest)
model_temp <- update(model5, . ~ . +  merged + avgfem + avgage + avglowgr)

# Mixed contract
model1 <- survival::survreg(data = dataset %>%
                      filter(sptype == 2, contract == 3) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1, dist = "weibull", 
                  cluster = schoolid) 

model2 <- update(model1, . ~ . + marstat)
model3 <- update(model2, . ~ . + gender)
model4 <- update(model3, . ~ . + lowgroup)
model5 <- update(model4, . ~ . + classize + schsize + public + protest)
model_mix <- update(model5, . ~ . +  merged + avgfem + avgage + avglowgr)


models <- list(model_fixed, model_temp, model_mix)

tab <- modelsummary(models,
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_omit = c("BIC|iter"),
             title = "Weibull Models - Models for the all contract types",
             out = "kableExtra") %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "scale_down"))

tab %>%
    # column labels
    add_header_above(c(" " = 1, "Fixed contract " = 1, "Temporary contract" = 1, "Mixed contract" = 1))
```
\clearpage

3.1 Estimate a Piece Wise Constant (PWC) model for the entire sample. Use the stsplit command to create multiple record data. You can have as many steps as the data allow you to take, but first start with only a few (3 or 4 steps). Next estimate a model with 15-20 steps, or even more. Plot de duration pattern implied by the estimates and comment on these and the regression parameters. How do the regression parameters ($\beta$) compare with those of the Weibull model? 

## We estimate a piece wise constant. 

```{r}
dataset2 <- dataset %>%
  filter(sptype == 2) %>%
  mutate(rcensor = if_else(rcensor == 1, 0, 1), 
         time = case_when(
           splength < 20 ~ "period 1",
           between(splength, 21, 50) ~ "period 2",
           between(splength, 51, 100) ~ "period 3",
           splength > 100 ~ "period 4")) %>%
                      fastDummies::dummy_cols(select_columns="time")

model1 <- survival::survreg(data = dataset2 %>%
                      filter(sptype == 2) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1 + marstat+ contract + 
                      merged + lowgroup + classize + schsize + public + protest + 
                      avgfem + avgage + avglowgr + time, dist = "weibull", 
                  cluster = schoolid) 

create_surv_function_with_fit <- function(model){
    
    # Make kaplan meier
    
    
    # Add the weibull fit to the plot for the right intervals
    period1 <- 1:20
    period2 <- 20:50
    period3 <- 51:100
    period4 <- 100:365
    
    constant1 <- model$coefficients['(Intercept)']
    constant2 <- model$coefficients['timeperiod 2']
    constant3 <- model$coefficients['timeperiod 3']
    constant4 <- model$coefficients['timeperiod 4']
    
    alpha <- model$scale
    
    df <- data.frame(time = c(period1, period2, period3, period4), 
               constant = c(rep(constant1, length(period1)), rep(constant2, length(period2)), rep(constant3, length(period3)), rep(constant4, length(period4))))
    
    
    df <- df %>%
        mutate(hazard_rate = constant*alpha*time^(alpha-1),
               survivor_function = )
    
    return(df)
}

dataset3 <- dataset %>%
  filter(sptype == 2) %>%
  mutate(rcensor = if_else(rcensor == 1, 0, 1), 
         time = case_when(
           splength < 25 ~ "period 1",
           between(splength, 26, 50) ~ "period 2",
           between(splength, 51, 75) ~ "period 3",
           between(splength, 76, 100) ~ "period 4",
           between(splength, 101, 125) ~ "period 5",
           between(splength, 126, 150) ~ "period 6",
           between(splength, 151, 175) ~ "period 7",
           between(splength, 176, 200) ~ "period 8",
           between(splength, 201, 225) ~ "period 9",
           between(splength, 226, 250) ~ "period 10",
           between(splength, 251, 275) ~ "period 11",
           between(splength, 300, 325) ~ "period 12",
           between(splength, 326, 350) ~ "period 13",
           splength > 350 ~ "period 14")) %>%
                      fastDummies::dummy_cols(select_columns="time")

model2 <- survival::survreg(data = dataset3 %>%
                      filter(sptype == 2) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1 + marstat+ contract + 
                      merged + lowgroup + classize + schsize + public + protest + 
                      avgfem + avgage + avglowgr + time, dist = "weibull", 
                  cluster = schoolid) 

models <- list(model2, model1)

```

```{r}
tab <- modelsummary(models,
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_omit = c("BIC|iter"),
             title = "PWC (Weibull)",
             out = "kableExtra") %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "scale_down"))

tab %>%
    # column labels
    add_header_above(c(" " = 1, "PWC 14 steps" = 1, "PWC 4 steps" = 1))
```

3.2 Estimate separate models for males and females. 

First we estimate a PWC model for males.
```{r}
dataset2 <- dataset %>%
  filter(sptype == 2, gender == 1) %>%
  mutate(rcensor = if_else(rcensor == 1, 0, 1), 
         time = case_when(
           splength < 20 ~ "period 1",
           between(splength, 21, 50) ~ "period 2",
           between(splength, 51, 100) ~ "period 3",
           splength > 100 ~ "period 4")) %>%
                      fastDummies::dummy_cols(select_columns="time")

model1 <- survival::survreg(data = dataset2 %>%
                      filter(sptype == 2) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1 + marstat+ contract + 
                      merged + lowgroup + classize + schsize + public + protest + 
                      avgfem + avgage + avglowgr + time, dist = "weibull", 
                  cluster = schoolid) 

dataset3 <- dataset %>%
  filter(sptype == 2, gender == 1) %>%
  mutate(rcensor = if_else(rcensor == 1, 0, 1), 
         time = case_when(
           splength < 25 ~ "period 1",
           between(splength, 26, 50) ~ "period 2",
           between(splength, 51, 75) ~ "period 3",
           between(splength, 76, 100) ~ "period 4",
           between(splength, 101, 125) ~ "period 5",
           between(splength, 126, 150) ~ "period 6",
           between(splength, 151, 175) ~ "period 7",
           between(splength, 176, 200) ~ "period 8",
           between(splength, 201, 225) ~ "period 9",
           between(splength, 226, 250) ~ "period 10",
           between(splength, 251, 275) ~ "period 11",
           between(splength, 300, 325) ~ "period 12",
           between(splength, 326, 350) ~ "period 13",
           splength > 350 ~ "period 14")) %>%
                      fastDummies::dummy_cols(select_columns="time")

model2 <- survival::survreg(data = dataset3 %>%
                      filter(sptype == 2) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1 + marstat+ contract + 
                      merged + lowgroup + classize + schsize + public + protest + 
                      avgfem + avgage + avglowgr + time, dist = "weibull", 
                  cluster = schoolid) 

models <- list(model2, model1)
```

```{r}
tab <- modelsummary(models,
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_omit = c("BIC|iter"),
             title = "PWC (Weibull) - Males only",
             out = "kableExtra") %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "scale_down"))

tab %>%
    # column labels
    add_header_above(c(" " = 1, "PWC 14 steps" = 1, "PWC 4 steps" = 1))
```

Now we estimate the same model for females.

```{r}
dataset2 <- dataset %>%
  filter(sptype == 2, gender == 2) %>%
  mutate(rcensor = if_else(rcensor == 1, 0, 1), 
         time = case_when(
           splength < 20 ~ "period 1",
           between(splength, 21, 50) ~ "period 2",
           between(splength, 51, 100) ~ "period 3",
           splength > 100 ~ "period 4")) %>%
                      fastDummies::dummy_cols(select_columns="time")

model1 <- survival::survreg(data = dataset2 %>%
                      filter(sptype == 2) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1 + marstat+ contract + 
                      merged + lowgroup + classize + schsize + public + protest + 
                      avgfem + avgage + avglowgr + time, dist = "weibull", 
                  cluster = schoolid) 

dataset3 <- dataset %>%
  filter(sptype == 2, gender == 2) %>%
  mutate(rcensor = if_else(rcensor == 1, 0, 1), 
         time = case_when(
           splength < 25 ~ "period 1",
           between(splength, 26, 50) ~ "period 2",
           between(splength, 51, 75) ~ "period 3",
           between(splength, 76, 100) ~ "period 4",
           between(splength, 101, 125) ~ "period 5",
           between(splength, 126, 150) ~ "period 6",
           between(splength, 151, 175) ~ "period 7",
           between(splength, 176, 200) ~ "period 8",
           between(splength, 201, 225) ~ "period 9",
           between(splength, 226, 250) ~ "period 10",
           between(splength, 251, 275) ~ "period 11",
           between(splength, 300, 325) ~ "period 12",
           between(splength, 326, 350) ~ "period 13",
           splength > 350 ~ "period 14")) %>%
                      fastDummies::dummy_cols(select_columns="time")

model2 <- survival::survreg(data = dataset3 %>%
                      filter(sptype == 2) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1 + marstat+ contract + 
                      merged + lowgroup + classize + schsize + public + protest + 
                      avgfem + avgage + avglowgr + time, dist = "weibull", 
                  cluster = schoolid) 

models <- list(model2, model1)
```

```{r}
tab <- modelsummary(models,
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_omit = c("BIC|iter"),
             title = "PWC (Weibull) - Females only",
             out = "kableExtra") %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "scale_down"))

tab %>%
    # column labels
    add_header_above(c(" " = 1, "PWC 14 steps" = 1, "PWC 4 steps" = 1))
```

<!-- We moeten alleen nog plots maken voor de models. --> 

4. Estimate a Cox model and compare the most elaborate specification with the results of the PWC model

```{r}

baseline <- survival::coxph(data = dataset %>%
                      filter(sptype == 2) %>%
                    mutate(rcensor = if_else(rcensor == 1, 0, 1)),
                  formula = Surv(splength, rcensor) ~ 1)

model1 <- update(baseline, . ~ . + marstat + gender + contract + lowgroup + classize + schsize + public + protest)
model2 <- update(model1, . ~ . + merged + avgfem + avgage + avglowgr)
```



