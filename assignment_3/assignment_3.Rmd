---
title: "Applied Microeconometrics - Assignment 3"
author: "Walter Verwer (589962) & Bas Machielsen (590049)"
date: \today
output:
  pdf_document:
    includes:
      in_header: preamble.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse); library(plm); library(stargazer); library(modelsummary)
library(kableExtra); library(MatchIt)

dataset <- haven::read_dta("./CardKrueger.dta") 
```

Construct a variable full-time equivalent for both waves, which is the number of full-time employees plus the number of part-time employees divided by two and also add the number of managers.  I will simply refer to employees for this outcome variable. 

```{r}
dataset <- dataset %>%
    mutate(employees = EMPFT  + EMPPT/2 + NMGRS,
           employees2 = EMPFT2 + EMPPT2/2 + NMGRS2,
           changeemployees = employees - employees2)

```

(i) Compute separately for New Jersey and Pennsylvania the average number of employees in both waves, and compute the difference-in-difference estimate

```{r}
did <- dataset %>%
    group_by(STATE) %>%
    summarize(mean_before = mean(employees, na.rm = TRUE),
              mean_after = mean(employees2, na.rm = TRUE)) %>%
    mutate(STATE = if_else(STATE == 0, "PA", "NJ")) 

did %>%
  knitr::kable(booktabs=T) %>%
  kableExtra::kable_styling(font_size = 7, latex_options = "hold_position")

did$mean_after[2] - did$mean_after[1] - (did$mean_before[2] - did$mean_before[1])
```

Next  repeat  this,  but  only  considering  the  restaurants  that  responded  in both waves of the survey.

```{r}
did2 <- dataset %>%
    group_by(STATE) %>%
    filter(!is.na(employees), !is.na(employees2)) %>%
    summarize(mean_before = mean(employees, na.rm = TRUE),
              mean_after = mean(employees2, na.rm = TRUE)) %>%
    mutate(STATE = if_else(STATE == 0, "PA", "NJ")) 
    
did2$mean_after[2] - did2$mean_after[1] - (did2$mean_before[2] - did2$mean_before[1])
```

(ii) Estimate this model and next subsequently add characteristics of the restaurants observed in the first wave.  But think carefully which characteristics can be included.  How does the latter affect the estimate for the coefficient $\delta$?

```{r, results='asis'}

model1 <- lm(data = dataset, 
   formula = changeemployees ~ STATE)
model2 <- lm(data = dataset, 
             formula = changeemployees ~ STATE + SOUTHJ + CENTRALJ + SHORE + PA1)
model3 <- update(model1, . ~ . + NCALLS + WAGE_ST + INCTIME + FIRSTINC +
                   BONUS + MEALS + OPEN + HRSOPEN + PSODA + PFRY + NREGS + NREGS11)
model4 <- update(model2, . ~ . + NCALLS + WAGE_ST + INCTIME + FIRSTINC +
                   BONUS + MEALS + OPEN + HRSOPEN + PSODA + PFRY + NREGS + NREGS11)

models <- list(model1, model2, model3, model4) 

stargazer(models, omit.stat = c("ll", "ser", "rsq"), df=F, 
          omit = c("SOUTHJ", "CENTRALJ", "SHORE", "PA1"),
          add.lines = list(c("Region Dummies", "No", "Yes", "No", "Yes")),
          header = FALSE, font.size = "footnotesize")

```

<!--
purrr::map(models, ~ sandwich::vcovCL(.x, cluster = ))

How much can we trust DiD estimates? as a ref. paper as to why not to cluster
-->

We want to isolate the effect of the minimum wage by attributing it to the coefficient belonging to STATE, which means we have to account for all possible sources of variation not due to the minimum wage. This also means we cannot control for PCTAFF, because this is the mechanism we care about: if we conditioned on this variable, that would absorb all variation due to the minimum wage policy changes and would change our interpretation of the STATE coefficient to a partial instead of a total effect and bias it towards zero. 

(iii) Provide  a  balancing  table,  i.e.   show  the  sample  mean  of  characteristics observed  in  the  first  survey  separately  for  the  restaurants  in  New  Jersey and Pennsylvania.  What is your opinion about the balancing table?

```{r, results='asis', warning = FALSE}
dataset %>%
    mutate(STATE = if_else(STATE == 0, "PA", "NJ")) %>%
    filter(!is.na(changeemployees)) %>%
    rename_with(.fn = ~ stringr::str_replace(.x, "_", "")) %>%
    select(changeemployees, STATE, NCALLS, WAGEST, INCTIME, FIRSTINC, BONUS, PCTAFF, MEALS,
           OPEN, HRSOPEN, PSODA, PFRY, PENTREE, NREGS, NREGS11) %>%
    modelsummary::datasummary_balance(formula = ~ STATE, 
                                      dinm= TRUE, 
                                      output = "latex", 
                                      fmt = "%.3f",
                                      dinm_statistic = "p.value")
```

(iv) Check  for  the  different  characteristics  if  there  is  a  common  support  for restaurants in New Jersey and Pennsylvania.  And estimate a propensity score for being a restaurant in New Jersey.

```{r, warning = FALSE}
# Check for common support
dataset2 <- dataset %>%
    mutate(STATE = if_else(STATE == 0, "PA", "NJ")) %>%
    filter(!is.na(changeemployees)) %>%
    rename_with(.fn = ~ stringr::str_replace(.x, "_", "")) %>%
    select(changeemployees, STATE, NCALLS, WAGEST, INCTIME, FIRSTINC, BONUS, PCTAFF, MEALS,
           OPEN, HRSOPEN, PSODA, PFRY, PENTREE, NREGS, NREGS11) 

emptycol = function(x) " "

boxplot1 <- lapply(dataset2 %>%
                     filter(STATE == "NJ") %>%
                  select(-STATE), na.omit) %>% lapply(scale)
boxplot2 <- lapply(dataset2 %>%
                     filter(STATE == "PA") %>%
                  select(-STATE), na.omit) %>% lapply(scale)

modelsummary::datasummary(
  data = dataset2, 
   NCALLS + WAGEST + INCTIME + FIRSTINC + BONUS + PCTAFF + MEALS +
           OPEN + HRSOPEN + PSODA + PFRY + PENTREE + NREGS + NREGS11 ~ 
    STATE * (Mean + SD + Heading("Boxplot")*emptycol + Heading("Histogram")*emptycol)) %>%
  column_spec(column = 4, image = spec_boxplot(boxplot1)) %>%
  column_spec(column = 8, image = spec_boxplot(boxplot2)) %>%
  column_spec(column = 5, image = spec_hist(boxplot1)) %>%
  column_spec(column = 9, image = spec_hist(boxplot2))


```

As indicated in the table, there is no common support for any of the variables, as we are dealing with continuous variables, so that the probability of realizing two zero outcomes is practically zero. We estimate two propensity scores, one extensive model, which sacrifices many observations, and one parsimonious model, which does not. 

```{r}
# Estimate propensity score
ps1 <- glm(STATE ~ WAGE_ST + INCTIME + FIRSTINC + BONUS + PCTAFF + MEALS + OPEN + HRSOPEN +
      PSODA + PFRY + PENTREE + NREGS + NREGS11 + NCALLS, 
    data = dataset, 
    family="binomial") 

ps2 <- glm(STATE ~ MEALS + OPEN + HRSOPEN + PSODA + PFRY, 
           data = dataset, 
    family="binomial") 

dataset <- dataset %>%
  modelr::add_predictions(ps1, type = "response") %>%
  rename("ps1" = "pred")

dataset <- dataset %>%
  modelr::add_predictions(ps2, type = "response") %>%
  rename("p2" = "pred")
```


```{r, warning = FALSE, message = FALSE}
dataset %>%
  ggplot(aes(x = ps1)) + geom_histogram()+ facet_wrap(~as.factor(STATE)) + theme_bw()
```

(v) Use propensity score matching to estimate the average treatment effect on the treated for the employment before and after the minimum wage increase in New Jersey, so on $E_{0i}$ and $E_{1i}$ separately. 

We report the results of (v), (vi) and (viii) in table \ref{tab:hoi}. We use the `MatchIt` package to estimate the propensity-score again and subsequently match using the nearest neighbor algorithm to compute $E_{0i}$:

```{r, warning = FALSE}
matched_data1 <- MatchIt::matchit(STATE ~ MEALS + OPEN + HRSOPEN + PSODA + PFRY,
                 data = dataset %>%
                   select(employees, STATE, MEALS, OPEN, HRSOPEN, PSODA, PFRY) %>%
                   na.omit(), 
                 method = "nearest") %>%
  match.data()

e_0i <- lm(employees ~ STATE + MEALS + OPEN + HRSOPEN + PSODA + PFRY, data = matched_data1)
```

And $E_{1i}$:

```{r, warning = FALSE}
matched_data2 <- MatchIt::matchit(STATE ~ MEALS + OPEN + HRSOPEN + PSODA + PFRY,
                 data = dataset %>%
                   select(employees2, STATE, MEALS, OPEN, HRSOPEN, PSODA, PFRY) %>%
                   na.omit(), 
                 method = "nearest") %>%
  match.data()

e_1i <- lm(employees2 ~ STATE + MEALS + OPEN + HRSOPEN + PSODA + PFRY, data = matched_data2)

```

(vi) Now use propensity score matching to estimate the average treatment effect on the treated on the change in employment in the restaurants, so $E_{1i}-E_{0i}$. 

```{r, warning = FALSE}
matched_data3 <- MatchIt::matchit(STATE ~ MEALS + OPEN + HRSOPEN + PSODA + PFRY,
                 data = dataset %>%
                   select(changeemployees, STATE, MEALS, OPEN, HRSOPEN, PSODA, PFRY) %>%
                   na.omit(), 
                 method = "nearest") %>%
  match.data()

ate <- lm(changeemployees ~ STATE + MEALS + OPEN + HRSOPEN + PSODA + PFRY, data = matched_data3)

```


```{r, results='asis'}
stargazer(e_0i, e_1i, ate, header = F, 
          omit.stat = c("ll", "ser", "rsq"), df = F,
          font.size = "footnotesize",
          label="tab:hoi")

```
(vii) Now check the sensitivity of the propensity score matching estimate by also computing the weighting estimators for the average treatment effect on the treated. 

```{r}

```
